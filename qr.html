<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLIP Station Finder</title>
    <style>
        #map { height: 90vh; width: 100%; }
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        h2 { text-align: center; }
    </style>
</head>
<body>
    <h2>Find the Nearest FLIP Station</h2>
    <div id="map"></div>
    
    <script>
        let map, userMarker, directionsService, directionsRenderer;
        const flipStations = [
            { name: "FLIP Station 1", lat: 46.624722, lng: 14.305278 },
            { name: "FLIP Station 2", lat: 46.636389, lng: 14.312500 },
            { name: "FLIP Station 3", lat: 46.619444, lng: 14.287778 }
        ];

        async function initMap() {
            try {
                // Load required libraries
                const { Map } = await google.maps.importLibrary("maps");
                const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
                const { DirectionsService, DirectionsRenderer } = await google.maps.importLibrary("routes");
                const { Spherical } = await google.maps.importLibrary("geometry");
                
                // Initialize map
                map = new Map(document.getElementById("map"), {
                    center: { lat: 46.636, lng: 14.312 },
                    zoom: 10,
                    mapId: "DEMO_MAP_ID" // Optional but recommended
                });
                
                directionsService = new DirectionsService();
                directionsRenderer = new DirectionsRenderer({ map });
                
                // Try to get user location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            // Create user marker
                            const userPin = new PinElement({
                                background: "#4285F4",
                                borderColor: "#ffffff",
                                glyphColor: "#ffffff",
                                scale: 1.5
                            });
                            
                            userMarker = new AdvancedMarkerElement({
                                position: userLocation,
                                map: map,
                                title: "Your Location",
                                content: userPin.element
                            });
                            
                            map.setCenter(userLocation);
                            await findNearestStation(userLocation, AdvancedMarkerElement, PinElement, Spherical);
                        },
                        (error) => {
                            console.error("Geolocation error:", error);
                            useDefaultLocation(AdvancedMarkerElement, PinElement, Spherical);
                        }
                    );
                } else {
                    useDefaultLocation(AdvancedMarkerElement, PinElement, Spherical);
                }
            } catch (error) {
                console.error("Map initialization error:", error);
                alert("Failed to load Google Maps. Please try again later.");
            }
        }

        async function useDefaultLocation(AdvancedMarkerElement, PinElement, Spherical) {
            alert("Using default location in Carinthia.");
            const defaultLocation = { lat: 46.636, lng: 14.312 };
            await findNearestStation(defaultLocation, AdvancedMarkerElement, PinElement, Spherical);
        }

        async function findNearestStation(userLocation, AdvancedMarkerElement, PinElement, Spherical) {
            try {
                let minDistance = Infinity;
                let nearestStation = null;
                
                // Add all station markers and find nearest
                for (const station of flipStations) {
                    const distance = Spherical.computeDistanceBetween(
                        new google.maps.LatLng(userLocation.lat, userLocation.lng),
                        new google.maps.LatLng(station.lat, station.lng)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStation = station;
                    }
                    
                    // Create station marker
                    const stationPin = new PinElement({
                        background: "#EA4335",
                        borderColor: "#ffffff",
                        glyphColor: "#ffffff"
                    });
                    
                    new AdvancedMarkerElement({
                        position: { lat: station.lat, lng: station.lng },
                        map: map,
                        title: station.name,
                        content: stationPin.element
                    });
                }
                
                if (nearestStation) {
                    await showRoute(userLocation, nearestStation);
                }
            } catch (error) {
                console.error("Error finding nearest station:", error);
            }
        }

        async function showRoute(userLocation, station) {
            try {
                const response = await directionsService.route({
                    origin: userLocation,
                    destination: { lat: station.lat, lng: station.lng },
                    travelMode: 'DRIVING'
                });
                
                directionsRenderer.setDirections(response);
                
                // Show info window
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div><h3>${station.name}</h3><p>This is the nearest FLIP station to your location.</p></div>`
                });
                
                setTimeout(() => {
                    infoWindow.open(map, userMarker);
                }, 1000);
            } catch (error) {
                console.error("Directions error:", error);
                alert('Could not find a route: ' + error);
            }
        }
    </script>
    
    <!-- Replace YOUR_ACTUAL_API_KEY with your real API key -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_ACTUAL_API_KEY&loading=async&libraries=places,geometry,marker&callback=initMap">
    </script>
</body>
</html>